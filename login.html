<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Karnal Highschool - Staff Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <style>
        /* --- CORE STYLES (Mostly Unchanged) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; background-color: #f4f7fa; color: #333; }
        .hidden { display: none !important; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }

        /* --- LOGIN SCREEN THEME (Unchanged) --- */
        .login-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f7fa; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background-color: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border-top: 5px solid #d9534f; }
        .login-logo-container { margin-bottom: 25px; } .login-logo-container img { max-width: 150px; height: auto; } .login-box h2 { margin-bottom: 25px; color: #333; font-size: 1.6rem; } .login-box .input-group { margin-bottom: 20px; text-align: left; } .login-box label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; } .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; } .login-box button { width: 100%; padding: 12px; border: none; border-radius: 5px; background-color: #d9534f; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s; } .login-box button:disabled { background-color: #95a5a6; cursor: not-allowed; } .login-box button:hover:not(:disabled) { background-color: #c9302c; } .error-message { color: #d9534f; margin-top: 15px; font-weight: 500; min-height: 20px; } .switch-login-method { margin-top: 20px; color: #4a90e2; cursor: pointer; font-size: 0.9rem; }
        
        /* --- DASHBOARD THEME (Updated) --- */
        .dashboard-container { display: flex; opacity: 0; transition: opacity 0.5s ease; }
        .dashboard-container.visible { opacity: 1; }
        .sidebar { width: 260px; background-color: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; top: 0; left: 0; overflow-y: auto; }
        .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #4a627a; } .sidebar-logo { max-width: 180px; margin-bottom: 15px; } .sidebar-header h2 { font-size: 1.3rem; } .sidebar-nav ul { list-style: none; padding: 0; } .sidebar-nav li a { display: block; color: #ecf0f1; text-decoration: none; padding: 15px 20px; border-radius: 5px; margin-bottom: 10px; transition: background-color 0.3s; } .sidebar-nav li a.active, .sidebar-nav li a:hover { background-color: #d9534f; color: #fff; } .sidebar-nav li a i { margin-right: 15px; width: 20px; }
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; color: #333; }
        .user-profile { display: flex; align-items: center; font-size: 1rem; } .user-profile span { margin-right: 15px; } .logout-btn { background: none; border: none; color: #d9534f; font-size: 1.5rem; cursor: pointer; }

        /* --- NEW: Header Controls (Academic Year) --- */
        .header-controls label { margin-right: 8px; font-weight: 500; color: #555; }
        .header-controls select { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9rem; }

        /* --- NEW: Stat Cards --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 25px; color: white; border-radius: 8px; position: relative; overflow: hidden; }
        .stat-card i { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); font-size: 4.5rem; opacity: 0.2; }
        .stat-card h2 { font-size: 3rem; margin-bottom: 5px; }
        .stat-card p { font-size: 1.1rem; font-weight: 500; }
        .color-red { background-color: #d9534f; }
        .color-teal { background-color: #26a69a; }
        .color-green { background-color: #5cb85c; }
        .color-blue { background-color: #428bca; }

        /* --- NEW: Dashboard Main Layout (2 Columns) --- */
        .dashboard-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-column { flex: 3; /* Takes up 3/4 of the space */ }
        .side-column { flex: 1; /* Takes up 1/4 of the space */ }

        /* --- NEW: Announcements Card --- */
        .announcements-card h2 { display: flex; align-items: center; margin-bottom: 15px; font-size: 1.3rem; }
        .announcements-card h2 i { margin-right: 10px; color: #d9534f; }
        .announcements-card ul { list-style: none; padding-left: 5px; }
        .announcements-card li { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .announcements-card li:last-child { border-bottom: none; }
        .announcements-card li span { font-size: 0.8rem; color: #777; display: block; margin-top: 4px; }

        /* --- Student Table (Unchanged) --- */
        .student-table { width: 100%; border-collapse: collapse; } .student-table th, .student-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; } .student-table th { background-color: #f4f7fa; font-weight: 600; color: #555; } .student-table tbody tr:hover { background-color: #f9f9f9; } .loading-message, .error-message-table { text-align: center; padding: 20px; color: #777; font-style: italic; }
    </style>
</head>
<body>

    <!-- ======================= LOGIN SCREEN (Unchanged) ======================= -->
    <div id="login-container" class="login-container">
        <!-- ... Your existing login box HTML ... -->
        <div class="login-box"> <div class="login-logo-container"> <img src="logo.jpeg" alt="Karnal Highschool Logo"> </div> <h2>Karnal Highschool Staff Login</h2> <div id="email-login-view"> <form id="login-form"> <div class="input-group"> <label for="email">Email</label> <input type="email" id="email" required> </div> <div class="input-group"> <label for="password">Password</label> <input type="password" id="password" required> </div> <button type="submit">Login</button> </form> <p class="switch-login-method" onclick="toggleLoginView('phone')">Or, Login with Mobile OTP</p> </div> <div id="phone-login-view" class="hidden"> <form id="phone-login-form"> <div class="input-group"> <label for="phone-number">Mobile Number</label> <input type="tel" id="phone-number" placeholder="+91 98765 43210" required> </div> <button id="send-otp-btn" type="submit">Send OTP</button> </form> <p class="switch-login-method" onclick="toggleLoginView('email')">Or, Login with Email</p> </div> <div id="otp-login-view" class="hidden"> <form id="otp-login-form"> <p>Enter the 6-digit code sent to your mobile.</p> <div class="input-group"> <label for="otp-code">OTP Code</label> <input type="number" id="otp-code" required> </div> <button id="verify-otp-btn" type="submit">Verify OTP</button> </form> <p class="switch-login-method" onclick="toggleLoginView('phone')">Change Number</p> </div> <p id="error-message" class="error-message"></p> <div id="recaptcha-container"></div> </div>
    </div>

    <!-- ======================= DASHBOARD (Updated) ======================= -->
    <div id="dashboard-container" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header"> <img src="logo.jpeg" alt="Karnal Highschool Logo" class="sidebar-logo"> <h2>Staff Dashboard</h2> </div> <nav class="sidebar-nav"> <ul> <li><a href="#" class="active"><i class="fa-solid fa-table-columns"></i> Dashboard</a></li> <li><a href="#"><i class="fa-solid fa-users"></i> Student Catalogue</a></li> <li><a href="#"><i class="fa-solid fa-file-invoice"></i> Generate LC</a></li> <li><a href="#"><i class="fa-solid fa-file-circle-check"></i> Generate Bonafide</a></li> </ul> </nav>
        </div>
        <div class="main-content">
            <header class="header">
                <div>
                    <h1>Dashboard</h1>
                    <p style="color: #777;">Welcome back, here is your school's overview.</p>
                </div>
                <div class="header-controls">
                    <label for="academic-year">Academic Year:</label>
                    <select id="academic-year">
                        <option selected>2024-2025</option>
                        <option>2023-2024</option>
                    </select>
                </div>
                <div class="user-profile"> <span id="user-email"></span> <button id="logout-btn" class="logout-btn" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button> </div>
            </header>
            <main> 
                <!-- NEW: Stat Cards Grid -->
                <div class="stats-grid">
                    <div class="stat-card color-red">
                        <h2 id="total-students-stat">0</h2> <p>Total Active Students</p> <i class="fa-solid fa-users"></i>
                    </div>
                    <div class="stat-card color-teal">
                        <h2 id="total-boys-stat">0</h2> <p>Total Boys</p> <i class="fa-solid fa-person"></i>
                    </div>
                    <div class="stat-card color-green">
                        <h2 id="total-girls-stat">0</h2> <p>Total Girls</p> <i class="fa-solid fa-person-dress"></i>
                    </div>
                    <div class="stat-card color-blue">
                        <h2 id="total-classes-stat">0</h2> <p>Total Classes</p> <i class="fa-solid fa-school"></i>
                    </div>
                </div>

                <!-- NEW: Two-column Layout -->
                <div class="dashboard-layout">
                    <div class="main-column">
                        <div id="student-data-container" class="card">
                            <h2>Active Student Roster</h2>
                            <table class="student-table">
                                <thead>
                                    <tr>
                                        <th>Reg. No</th>
                                        <th>Name</th>
                                        <th>Class Admitted</th>
                                        <th>Gender</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="side-column">
                        <div class="announcements-card card">
                            <h2><i class="fa-solid fa-bullhorn"></i> Announcements</h2>
                            <ul>
                                <li>Unit Test exams will begin next week. <span>Posted: 1 day ago</span></li>
                                <li>Annual sports day registrations are now open. <span>Posted: 3 days ago</span></li>
                                <li>Parent-teacher meeting scheduled for Saturday. <span>Posted: 5 days ago</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCu9C0ZpPnKzPCJ11gQc7Vlk3lnfaJH9fU",
            authDomain: "my-login-app-df9a7.firebaseapp.com",
            projectId: "my-login-app-df9a7",
            storageBucket: "my-login-app-df9a7.appspot.com",
            messagingSenderId: "325062660131",
            appId: "1:325062660131:web:09965afc828fcb26d76196"
        };
        
        // --- PASTE YOUR **PUBLISH TO WEB** CSV URL HERE ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRk0ZAp11S_amAlCAhGCpVfDFq1ZTfz7AspbzOEGZMM57hubJPitipsiQuPrGMcrc8FImynLMZsRYQp/pub?output=csv';

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const userEmailSpan = document.getElementById('user-email');
        const errorMessage = document.getElementById('error-message');
        const emailView = document.getElementById('email-login-view');
        const phoneView = document.getElementById('phone-login-view');
        const otpView = document.getElementById('otp-login-view');
        const loginForm = document.getElementById('login-form');
        const phoneLoginForm = document.getElementById('phone-login-form');
        const otpLoginForm = document.getElementById('otp-login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const studentTableBody = document.getElementById('student-table-body');
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const entry = {};
                headers.forEach((header, index) => { entry[header] = values[index]; });
                return entry;
            });
        }
        
        // --- NEW: Function to update the colorful stat cards ---
        function updateStatCards(students) {
            const totalStudents = students.length;
            const totalBoys = students.filter(s => s.Gender === 'Male').length;
            const totalGirls = students.filter(s => s.Gender === 'Female').length;
            
            // Calculate unique classes
            const classNames = students.map(s => s['STD and Class admitted into']);
            const totalClasses = new Set(classNames).size;

            document.getElementById('total-students-stat').textContent = totalStudents;
            document.getElementById('total-boys-stat').textContent = totalBoys;
            document.getElementById('total-girls-stat').textContent = totalGirls;
            document.getElementById('total-classes-stat').textContent = totalClasses;
        }

        function renderStudentTable(students) {
            studentTableBody.innerHTML = ''; 
            if (!students || students.length === 0) {
                studentTableBody.innerHTML = `<tr><td colspan="4" class="loading-message">No active students found.</td></tr>`;
                return;
            }
            // Display only a few students in the dashboard preview
            const studentsToDisplay = students.slice(0, 10);
            studentsToDisplay.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student['Reg.no'] || 'N/A'}</td>
                    <td>${student['Name'] || 'N/A'}</td>
                    <td>${student['STD and Class admitted into'] || 'N/A'}</td>
                    <td>${student['Gender'] || 'N/A'}</td>
                `;
                studentTableBody.appendChild(row);
            });
        }
        
        async function fetchStudentData() {
            studentTableBody.innerHTML = `<tr><td colspan="4" class="loading-message">Loading student data...</td></tr>`;
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const csvText = await response.text();
                const allStudents = parseCSV(csvText);

                const activeStudents = allStudents.filter(student => {
                    const leavingDate = student['Date of leaving School'];
                    return !leavingDate || leavingDate.trim() === '';
                });

                // Call the new functions
                updateStatCards(activeStudents);
                renderStudentTable(activeStudents);

            } catch (error) {
                console.error('Failed to fetch student data:', error);
                studentTableBody.innerHTML = `<tr><td colspan="4" class="error-message-table">Error loading data. Check URL and console.</td></tr>`;
            }
        }

        // --- Authentication Logic (Unchanged) ---
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
        function toggleLoginView(view) { errorMessage.textContent = ''; emailView.classList.toggle('hidden', view !== 'email'); phoneView.classList.toggle('hidden', view !== 'phone'); otpView.classList.toggle('hidden', view !== 'otp'); }
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(error => errorMessage.textContent = error.message); });
        phoneLoginForm.addEventListener('submit', (e) => { e.preventDefault(); const phoneNumber = document.getElementById('phone-number').value; const appVerifier = window.recaptchaVerifier; const sendOtpBtn = document.getElementById('send-otp-btn'); sendOtpBtn.disabled = true; sendOtpBtn.textContent = 'Sending...'; auth.signInWithPhoneNumber(phoneNumber, appVerifier).then(confirmationResult => { window.confirmationResult = confirmationResult; toggleLoginView('otp'); }).catch(error => { errorMessage.textContent = "Error: " + error.message; recaptchaVerifier.render().then(widgetId => recaptchaVerifier.reset(widgetId)); }).finally(() => { sendOtpBtn.disabled = false; sendOtpBtn.textContent = 'Send OTP'; }); });
        otpLoginForm.addEventListener('submit', (e) => { e.preventDefault(); const otpCode = document.getElementById('otp-code').value; const verifyOtpBtn = document.getElementById('verify-otp-btn'); verifyOtpBtn.disabled = true; verifyOtpBtn.textContent = 'Verifying...'; window.confirmationResult.confirm(otpCode).catch(error => { errorMessage.textContent = "Invalid OTP. Please try again."; }).finally(() => { verifyOtpBtn.disabled = false; verifyOtpBtn.textContent = 'Verify OTP'; }); });
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged(user => {
            if (user) {
                userEmailSpan.textContent = `Welcome, ${user.email || user.phoneNumber}`;
                loginContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                dashboardContainer.classList.add('visible');
                fetchStudentData(); 
            } else {
                toggleLoginView('email');
                loginContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                dashboardContainer.classList.remove('visible');
            }
        });
    </script>
</body>
</html>